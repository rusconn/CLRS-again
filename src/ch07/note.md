# 7 章 クイックソート

クイックソートは実際によく使われるソート。  
期待実行時間が $\Theta(n\lg n)$ であり、定数コストも小さく高速。  
しかし内容は複雑で、最悪実行時間は $\Theta(n^2)$ 。

## 7.1 クイックソートの記述

マージソートと同様、クイックソートは第 $2.3.1$ 項で導入した分割統治法に基づいている。

- **分割:** $A[p..r]$ を $A[p..q-1]$ と $A[q+1..r]$ に分割する。  
  前者はどの要素も $A[q]$ 以下、後者はどの要素も $A[q]$ 以上となるようにする。空になることもある。  
  添字 $q$ はこの分割手続きの中で計算する。

- **統治:** $A[p..q-1]$ と $A[q+1..r]$ をクイックソートで再帰的にソートする。

- **結合:** 必要ない。既にソートされている。

手続きを示す。

```pseudo
QUICKSORT(A, p, r)
  if p < r
    q = PARTITION(A, p, r)
    QUICKSORT(A, p, q - 1)
    QUICKSORT(A, q + 1, r)
```

```pseudo
PARTITION(A, p, r):
  x = A[r]
  i = p - 1
  for j = p to r - 1
    if A[j] <= x
      i = i + 1
      A[i] を A[j] と交換する
  A[i + 1] を A[r] と交換する
  return i + 1
```

$x = A[r]$ を**ピボット**(pivot)という。

## 7.2 クイックソートの性能

クイックソートの実行時間は分割が均等か否かに依存する。  
つまりピボットの選択に依存する。  
分割が均等ならマージソートと、均等でなければ挿入ソートと漸近的性質が等しくなる。

### 最悪の分割

クイックソートが最悪の振舞いをするのは、分割手続きが元の問題を要素数 $n-1$ の部分問題と要素数 $0$ の部分問題に分割したとき。  
この場合の実行時間は漸化式

$$
  \begin{split}
    T(n) & = T(n - 1) + T(0) + \Theta(n) \\
         & = T(n - 1) + \Theta(n)
  \end{split}
$$

で記述され、これは $\Theta(n^2)$ となる。  
つまり、クイックソートの最悪実行時間は挿入ソートより良くならない。  
しかも $\Theta(n^2)$ が生じる入力は、挿入ソートなら $O(n)$ 時間で走る。

### 最良の分割

均等な分割が行われる場合、一方のサイズが $\lfloor n/2 \rfloor$ で他方が $\lceil n/2 \rceil$ となる。  
このときクイックソートは最も速く走り、実行時間は漸化式

$$
  T(n) = 2T(n/2) + \Theta(n)
$$

で記述される。マスター定理の場合２から、この漸化式の解は $T(n) = \Theta(n\lg n)$ である。  
したがって分割を均等にすることがアルゴリズムの漸近的な高速化につながる。

## 7.3 乱択版クイックソート

入力が既ソートに近いと分割が偏ってしまうので、ピボットを**無作為抽出**(random sampling)する。  
これにより、平均的にはそれなりにうまく２分割されると期待できる。

```pseudo
RANDOMIZED-QUICKSORT(A, p, r):
  if p < r
    q = RANDOMIZED-PARTITION(A, p, r)
    RANDOMIZED-QUICKSORT(A, p, q - 1)
    RANDOMIZED-QUICKSORT(A, q + 1, r)
```

```pseudo
RANDOMIZED-PARTITION(A, p, r):
  i = RANDOM(p, r)
  A[r] と A[i] を交換する
  return PARTITION(A, p, r)
```

## 7.4 クイックソートの解析

すべての要素が異なるという仮定の下で、 $\text{RANDOMIZED-PARTITION}$ を用いると、  
クイックソートの期待実行時間は $O(n\lg n)$ になる。詳細は省略。

[← 前へ](../ch06/note.md)
